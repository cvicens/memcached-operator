# New project to test our operator
oc new-project memcached

# Create the operator scaffold
operator-sdk new memcached-operator --type=ansible --api-version=cache.cvicens.com/v1alpha1 --kind=Memcached --skip-git-init

> If you know you need a playbook: operator-sdk new memcached-operator --type=ansible --api-version=cache.cvicens.com/v1alpha1 --kind=Memcached --generate-playbook  --skip-git-init


cd memcached-operator

# Customize the Operator Logic
Thus far, we have created the memcached-operator project specifically for watching the Memcached resource with APIVersion 'cache.example.com/v1apha1' and Kind 'Memcached'. Now it's time to define the Operator logic.

## Customize the Operator logic
For this example the memcached-operator will execute the following reconciliation logic for each 'Memcached' Custom Resource (CR):

* Create a memcached Deployment if it doesn't exist
* Ensure that the Deployment size is the same as specified by the 'Memcached' CR

## Installing an existing Role from Ansible Galaxy

To speed development of our Operator up, we can reuse an existing Role. We will install a Role from Ansible Galaxy into our Operator:

[dymurray.memcached_operator_role (galaxy.ansible.com)](https://galaxy.ansible.com/dymurray/memcached_operator_role)

Run to install the Ansible Role inside of the project:

~~~shell
ansible-galaxy install dymurray.memcached_operator_role -p ./roles
~~~

Let's see which roles do we have...

~~~
$ ls roles/
dymurray.memcached_operator_role memcached
~~~

## Removing the unneeded Role
Since we'll be reusing the logic from 'dymurray.memcached_operator_role', we can safely delete the placeholder Role generated by the the 'operator-sdk new' command we ran previously.

~~~shell
rm -rf ./roles/memcached
~~~

## Taking a Closer Look: dymurray.memcached_operator_role
We can use the 'tree' command to get a general sense of the memcached Role installed from Ansible Galaxy.

~~~shell
tree roles/dymurray.memcached_operator_role
~~~

## Role Variables
This Role provides the user with a variable size which is an integer to control the number of Deployment replicas to create. You can find the default for this variable in the memcached Role defaults/main.yml file:

~~~yaml
---
# defaults file for Memcached
size: 1
~~~

## Role Tasks
Be sure to examine the memcached Role tasks/main.yml file, which uses the k8s (Kubernetes) Ansible module to create a Deployment of memcached.

~~~yaml
---
# tasks file for Memcached
- name: start memcached
  k8s:
    definition:
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        name: '{{ meta.name }}-memcached'
        namespace: '{{ meta.namespace }}'
      spec:
        replicas: "{{size}}"
        selector:
          matchLabels:
            app: memcached

  [ ... continued ...]
~~~

Next, we'll modify the necessary files to ensure that our Operator uses this Role instead of the generated scaffolding Role. Let's modify watches.yaml.

## Correcting the Watches File
By default, the `memcached-operator` watches Memcached resource events as shown in `watches.yaml` and executes Ansible Role `memcached`.

Since we have swapped out the original Role for one from Ansible Galaxy, lets change the Watches file to reflect this:

~~~yaml
- version: v1alpha1
  group: cache.cvicens.com
  kind: Memcached
  role: /opt/ansible/roles/dymurray.memcached_operator_role
~~~

## Build and run the Operator

TIP: In order that you can still run commands from the command line as a cluster admin, the sudoer Role needs to be enabled for your user account. To execute a command as a cluster admin add the `--as system:admin` option to the command.

Before running the Operator, Kubernetes needs to know about the new custom resource definition the Operator will be watching.

Deploy the Memcached Custom Resource Definition (CRD):

~~~shell
oc create -f deploy/crds/cache_v1alpha1_memcached_crd.yaml --as system:admin
~~~

By running this command, we are creating a new resource type, memcached, on the cluster. We will give our Operator work to do by creating and modifying resources of this type.

# Ways to Run an Operator
Once the CRD is registered, there are two ways to run the Operator:

* As a pod inside an Openshift cluster
* As a go program outside the cluster using operator-sdk

For the sake of this tutorial, we will run the Operator as a pod inside of a Openshift Cluster. If you are interested in learning more about running the Operator using operator-sdk, see the up local instructions in Step 9 of this scenario.

## Run as a pod inside an Openshift cluster
Running as a pod inside a Openshift cluster is preferred for production use.

Let's build the memcached-operator image:

~~~shell
$ operator-sdk build memcached-operator:v0.0.1
INFO[0000] Building Docker image memcached-operator:v0.0.1 
Sending build context to Docker daemon    171kB
Step 1/3 : FROM quay.io/operator-framework/ansible-operator:v0.5.0
v0.5.0: Pulling from operator-framework/ansible-operator
...
Digest: sha256:9919407a30b24d459e1e4188d05936b52270cafcd53afc7d73c89be02262f8c5
Status: Downloaded newer image for quay.io/operator-framework/ansible-operator:v0.5.0
 ---> 1e857f3522b5
Step 2/3 : COPY roles/ ${HOME}/roles/
 ---> 5f2c4a33fda3
Step 3/3 : COPY watches.yaml ${HOME}/watches.yaml
 ---> 312bd4e98000
Successfully built 312bd4e98000
Successfully tagged memcached-operator:v0.0.1
INFO[0034] Operator build complete. 
~~~

## Modifying the Operator deploy manifest
Kubernetes deployment manifests are generated by 'operator-sdk new' in deploy/operator.yaml. We need to make a few changes to this file.

* image placeholder 'REPLACE_IMAGE' should be set to the previously-built image.
* imagePullPolicy from 'Always' to 'Never' since we aren't pushing our image to a registry.

~~~yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: memcached-operator
spec:
# [...]
      containers:
        - name: memcached-operator
          # Replace 'REPLACE_IMAGE' with the built image name
          image: REPLACE_IMAGE
          # Replace 'Always' with 'Never'
          imagePullPolicy: Always
# [...]
~~~

Open deploy/operator.yaml and replace `{{ REPLACE_IMAGE }}` by `memcached-operator:v0.0.1`, also make sure that `imagePullPolicy` is `Always`

Push image... there should be a nicer way...

~~~shell
docker tag memcached-operator:v0.0.1 cvicens/memcached-operator:v0.0.1
docker push cvicens/memcached-operator:v0.0.1
~~~

## Creating the Operator from deploy manifests
Now, we are ready to deploy the memcached-operator:

**Create Service Account for Operator to run as**

~~~shell
oc create -f deploy/service_account.yaml
~~~

**Create OpenShift Role specifying Operator Permissions**

~~~shell
oc create -f deploy/role.yaml --as system:admin
~~~

**Create OpenShift Role Binding assigning Permissions to Service Account**

~~~shell
oc create -f deploy/role_binding.yaml --as system:admin
~~~

**Create Operator Deployment Object**

~~~shell
oc create -f deploy/operator.yaml
~~~

Note: role.yaml and role_binding.yaml describe cluster-wide resources. Creating these requires elevated permissions.

## Verify that the memcached-operator is running

~~~shell
$ oc get deployment
NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
memcached-operator   1         1         1            1           25m
~~~

# Using the Operator
Now that we have deployed our Operator, let's create a CR and deploy an instance of memcached.

There is a sample CR in the scaffolding created as part of the Operator SDK:

~~~yaml
apiVersion: cache.example.com/v1alpha1
kind: Memcached
metadata:
  name: example-memcached
spec:
  # Add fields here
  size: 3
~~~

Let's go ahead and apply this in our Tutorial project to deploy 3 memcached pods, using our Operator:

# Create a Memcached CR instance
Inspect deploy/crds/cache_v1alpha1_memcached_cr.yaml, and then use it to create a Memcached custom resource:

~~~yaml
# deploy/crds/cache_v1alpha1_memcached_cr.yaml
apiVersion: cache.example.com/v1alpha1
kind: Memcached
metadata:
  name: example-memcached
spec:
  size: 3
~~~

~~~shell
oc create -f deploy/crds/cache_v1alpha1_memcached_cr.yaml --as system:admin
~~~


# Check that the Memcached Operator works as intended
Ensure that the memcached-operator creates the deployment for the CR:

~~~shell
 $ oc get deployment
NAME                 DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
memcached-operator   1       1       1          1         2m
example-memcached    3       3       3          3         1m
~~~

Check the pods to confirm 3 replicas were created:

~~~shell
$ oc get pods
NAME                                READY STATUS   RESTARTS AGE
example-memcached-6cc844747c-2hbln  1/1   Running  0        1m
example-memcached-6cc844747c-54q26  1/1   Running  0        1m
example-memcached-6cc844747c-7jfhc  1/1   Running  0        1m
memcached-operator-68b5b558c5-dxjwh 1/1   Running  0        2m
~~~

Change the Memcached CR to deploy 4 replicas
Change the spec.size field in deploy/crds/cache_v1alpha1_memcached_cr.yaml from 3 to 4 and apply the change:

~~~yaml
apiVersion: cache.example.com/v1alpha1
kind: Memcached
metadata:
  name: example-memcached
spec:
  size: 4
~~~

~~~shell
oc apply -f deploy/crds/cache_v1alpha1_memcached_cr.yaml --as system:admin
~~~

Confirm that the Operator changes the deployment size:

~~~shell
$ oc get deployment
NAME                DESIRED CURRENT  UP-TO-DATE  AVAILABLE  AGE
example-memcached   4       4        4           4          53s
memcached-operator  1       1        1           1          5m
~~~

Inspect the YAML list of 'memcached' resources in your project, noting that the 'spec.size' field is now set to 4.

~~~shell
oc get memcached  -o yaml --as system:admin
~~~

## Removing Memcached from the cluster
First, delete the 'memcached' CR, which will remove the 4 Memcached pods and the associated deployment.

~~~shell
oc delete -f deploy/crds/cache_v1alpha1_memcached_cr.yaml --as system:admin
~~~

$ oc get pods
NAME                                 READY STATUS  RESTARTS AGE
memcached-operator-7cc7cfdf86-vvjqk  1/1   Running 0        8m
~~~

Then, delete the memcached-operator deployment.

oc delete -f deploy/operator.yaml

Finally, verify that the memcached-operator is no longer running.

~~~shell
oc get deployment
~~~


#######

Running the Operator Locally (Outside the Cluster)
In order to speed up Operator deployment and testing, operator-sdk provides a mechanism to run the Operator outside of a cluster.

Copying Roles for local development
It is important that the Role path referenced in watches.yaml exists on your machine.

We previously ran our Ansible Operator from a container where the Role was copied to a known location specified by the Dockerfile.

To run our Operator locally, we will manually copy any Roles used by our Operator to a configured Ansible Roles path for our local machine (e.g /etc/ansible/roles).

cp -r ~/tutorial/memcached-operator/roles/dymurray.memcached_operator_role /opt/ansible/roles/

Running with 'operator-sdk up local'
Sample Commands
Running operator-sdk up local to run an Operator locally requires a KUBECONFIG value to connect with a cluster. Some sample commands are shown below.

$ operator-sdk up local # default, KUBECONFIG=$HOME/.kube/config
$ operator-sdk up local --kubeconfig=/tmp/config # KUBECONFIG='/tmp/config'
For this scenario, there is a properly permissioned KUBECONFIG at ~/backup/.kube/config. We'll run the command below to use it.

Start the Operator
operator-sdk up local --kubeconfig=/root/backup/.kube/config --namespace tutorial

Next open a 2nd terminal window, using the "+" tab and navigate to our Operator.

cd ~/tutorial/memcached-operator

Create the Custom Resource
Create the example Memcached CR that was generated at deploy/crds/cache_v1alpha1_memcached_cr.yaml:

oc create -f deploy/crds/cache_v1alpha1_memcached_cr.yaml --as system:admin

Ensure that the memcached-operator creates the deployment for the CR:


 $ oc get deployment
NAME               DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
example-memcached  4       4       4          4         34s

Check the pods to confirm 4 replicas were created:


 $ oc get pods
NAME                               READY STATUS   RESTARTS AGE
example-memcached-6cc844747c-dp8sx 1/1   Running  0        1m
example-memcached-6cc844747c-hk52c 1/1   Running  0        1m
example-memcached-6cc844747c-q75m4 1/1   Running  0        1m
example-memcached-6cc844747c-xp8qp 1/1   Running  0        1m

Cleanup
Clean up the resources:

oc delete -f deploy/crds/cache_v1alpha1_memcached_cr.yaml --as system:admin

oc delete -f deploy/role_binding.yaml

oc delete -f deploy/role.yaml

oc delete -f deploy/service_account.yaml

oc delete -f deploy/crds/cache_v1alpha1_memcached_crd.yaml --as system:admin